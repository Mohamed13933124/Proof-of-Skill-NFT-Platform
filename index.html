<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SkillCert ‚Äî Proof of Skill (Celo)</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Robust ethers loader with fallbacks -->
  <script>
    // Load script helper
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = () => resolve(src);
        s.onerror = () => reject(new Error('Failed to load ' + src));
        document.head.appendChild(s);
      });
    }

    // Ensure ethers is available (tries primary then fallbacks)
    (async function ensureEthers() {
      if (window.ethers) return;
      const candidates = [
        'https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js',
        'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js',
        'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js'
      ];
      let lastErr;
      for (const url of candidates) {
        try {
          await loadScript(url);
          if (window.ethers) return;
          lastErr = new Error('Loaded script but ethers not available: ' + url);
        } catch (e) {
          lastErr = e;
          console.warn('Ethers load failed for', url, e);
        }
      }
      console.error('All ethers CDN load attempts failed', lastErr);
      alert('Critical error: failed to load ethers.js library. Check network / CDN blocking.');
    })();
  </script>

  <style>
    body {
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    .certificate-card { transition: transform .28s ease, box-shadow .28s ease; }
    .certificate-card:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(0,0,0,.18); }
    .btn-primary { background: linear-gradient(90deg,#1e40af,#3b82f6); }
    .btn-primary:hover { transform: scale(1.02); }
    #statusMessage { max-width: 420px; right: 20px; bottom: 20px; }
  </style>
</head>
<body class="min-h-screen text-slate-900">

  <!-- Navbar -->
  <nav class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="text-2xl font-semibold">üéì SkillCert</div>
        <div class="text-sm text-yellow-400 font-medium">Celo Mainnet</div>
      </div>
      <div class="flex items-center gap-3">
        <button id="navHome" class="text-sm px-3 py-2">Home</button>
        <button id="navSkills" class="text-sm px-3 py-2">Available Skills</button>
        <button id="navCerts" class="text-sm px-3 py-2">My Certificates</button>
        <button id="connectBtn" class="btn-primary text-white px-4 py-2 rounded">Connect Wallet</button>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="max-w-7xl mx-auto p-6">
    <!-- Home -->
    <section id="homeSection" class="section mt-8">
      <div class="bg-white rounded-2xl p-10 shadow">
        <h1 class="text-3xl font-bold mb-2">Proof-of-Skill NFT Platform</h1>
        <p class="text-slate-600">Mint immutable skill certificates on the Celo blockchain.</p>
        <div class="mt-6">
          <button id="ctaSkills" class="btn-primary text-white px-5 py-3 rounded">Explore Skills ‚Üí</button>
        </div>
      </div>
    </section>

    <!-- Skills -->
    <section id="skillsSection" class="section hidden mt-8">
      <div class="bg-white rounded-2xl p-8 shadow">
        <h2 class="text-2xl font-bold mb-6">Available Skill Certificates</h2>

        <div id="walletWarning" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4">
          ‚ö†Ô∏è Please connect your wallet to claim certificates.
        </div>

        <div class="grid md:grid-cols-3 gap-6">
          <div class="certificate-card bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-lg border">
            <div class="text-4xl mb-3 text-center">üíª</div>
            <h3 class="text-xl font-semibold text-center mb-2">Coding</h3>
            <p class="text-sm text-slate-600 mb-4 text-center">Algorithms, data-structures, clean code</p>
            <button data-skill="Coding" class="claim-btn w-full btn-primary text-white py-2 rounded">Claim Certificate</button>
          </div>

          <div class="certificate-card bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-lg border">
            <div class="text-4xl mb-3 text-center">üé®</div>
            <h3 class="text-xl font-semibold text-center mb-2">Design</h3>
            <p class="text-sm text-slate-600 mb-4 text-center">UI/UX and product design</p>
            <button data-skill="Design" class="claim-btn w-full bg-purple-600 text-white py-2 rounded">Claim Certificate</button>
          </div>

          <div class="certificate-card bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-lg border">
            <div class="text-4xl mb-3 text-center">üìà</div>
            <h3 class="text-xl font-semibold text-center mb-2">Marketing</h3>
            <p class="text-sm text-slate-600 mb-4 text-center">Growth, analytics, content strategy</p>
            <button data-skill="Marketing" class="claim-btn w-full bg-green-600 text-white py-2 rounded">Claim Certificate</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Certificates -->
    <section id="certificatesSection" class="section hidden mt-8">
      <div class="bg-white rounded-2xl p-8 shadow">
        <h2 class="text-2xl font-bold mb-6">My Certificates</h2>
        <div id="certificatesGrid" class="grid md:grid-cols-3 gap-4"></div>
        <div id="noCertificates" class="text-slate-500 mt-6 hidden">You don't have any certificates yet.</div>
      </div>
    </section>
  </main>

  <!-- Status -->
  <div id="statusMessage" class="fixed bottom-6 right-6 hidden bg-white p-4 rounded shadow max-w-sm">
    <div id="statusText" class="text-slate-800"></div>
  </div>

  <!-- App Script (runs after ethers loaded) -->
  <script>
    // Wait for ethers to load then initialize app
    (function waitForEthersAndInit() {
      const maxWait = 6000; // ms
      const start = Date.now();

      (function check() {
        if (typeof window.ethers !== 'undefined') {
          initApp();
        } else if (Date.now() - start < maxWait) {
          setTimeout(check, 100);
        } else {
          console.error('ethers.js not loaded after timeout');
          alert('Critical: ethers.js failed to load. Please check network / CDN or try reloading.');
        }
      })();
    })();

    function initApp() {
      // ---------- CONFIG ----------
      const CONTRACT_ADDRESS = "0x1609a371790AaC42298Ded751E111f50057A71a4"; // provided deployed address
      const CONTRACT_ABI = [
        "function mintCertificate(string memory skillName) public returns (uint256)",
        "function getUserCertificates(address user) public view returns (string[] memory)"
      ];

      const CELO_MAINNET = {
        chainId: '0xa4ec', // 42220
        chainName: 'Celo Mainnet',
        nativeCurrency: { name: 'CELO', symbol: 'CELO', decimals: 18 },
        rpcUrls: ['https://forno.celo.org'],
        blockExplorerUrls: ['https://explorer.celo.org']
      };

      let provider = null;
      let signer = null;
      let contract = null;
      let userAddress = null;

      // ---------- UI helpers ----------
      const statusEl = document.getElementById('statusMessage');
      const statusText = document.getElementById('statusText');
      function showStatus(msg, type = 'info', ttl = 4500) {
        statusText.textContent = msg;
        statusEl.classList.remove('hidden', 'bg-blue-100', 'bg-green-100', 'bg-red-100');
        statusEl.classList.add(type === 'success' ? 'bg-green-100' : type === 'error' ? 'bg-red-100' : 'bg-blue-100');
        clearTimeout(window._statusTimer);
        window._statusTimer = setTimeout(() => statusEl.classList.add('hidden'), ttl);
      }

      // ---------- Navigation ----------
      function showSection(section) {
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        if (section === 'home') document.getElementById('homeSection').classList.remove('hidden');
        if (section === 'skills') {
          document.getElementById('skillsSection').classList.remove('hidden');
          document.getElementById('walletWarning').classList.add('hidden');
        }
        if (section === 'certificates') {
          document.getElementById('certificatesSection').classList.remove('hidden');
          loadUserCertificates();
        }
      }

      // ---------- Wallet connect ----------
      async function connectWallet() {
        try {
          if (typeof window.ethereum === 'undefined') {
            showStatus('Please install MetaMask to use this DApp.', 'error', 6000);
            return;
          }

          showStatus('Requesting wallet connection...', 'info');
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          if (!accounts || accounts.length === 0) throw new Error('No accounts returned');
          userAddress = accounts[0];

          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();

          const net = await provider.getNetwork();
          if (net.chainId !== 42220) {
            // attempt to switch to Celo Mainnet
            try {
              await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: CELO_MAINNET.chainId }]
              });
              // re-initialize provider & signer after switch
              provider = new ethers.providers.Web3Provider(window.ethereum);
              signer = provider.getSigner();
              showStatus('Network switched to Celo. Finalizing connection...', 'info', 3500);
            } catch (switchErr) {
              // if chain is not added, add it
              if (switchErr && switchErr.code === 4902) {
                try {
                  await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [CELO_MAINNET]
                  });
                  showStatus('Celo network added. Please approve switch in MetaMask and click Connect again.', 'info', 7000);
                  return;
                } catch (addErr) {
                  console.error('Add chain failed', addErr);
                  showStatus('Failed to add Celo network to MetaMask.', 'error', 6000);
                  return;
                }
              } else {
                console.error('Switch error', switchErr);
                showStatus('Failed to switch network. Please switch to Celo Mainnet manually.', 'error', 6000);
                return;
              }
            }
          }

          // Initialize contract
          contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

          // Update UI
          const btn = document.getElementById('connectBtn');
          btn.textContent = `${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
          btn.disabled = true;
          btn.classList.add('opacity-70');

          showStatus('Connected to Celo Mainnet ‚úÖ', 'success', 3000);

          // If user is on certificates view, load them
          if (!document.getElementById('certificatesSection').classList.contains('hidden')) {
            loadUserCertificates();
          }
        } catch (err) {
          console.error('connectWallet error', err);
          showStatus('Failed to connect wallet: ' + (err.reason || err.message || err), 'error', 7000);
        }
      }

      // ---------- Claim / Mint ----------
      async function claimCertificate(skillName) {
        if (!contract || !userAddress) {
          document.getElementById('walletWarning').classList.remove('hidden');
          showStatus('Please connect your wallet first.', 'error', 4000);
          return;
        }
        try {
          showStatus(`Minting "${skillName}" ‚Äî confirm in MetaMask...`, 'info', 6000);
          const tx = await contract.mintCertificate(skillName);
          showStatus('Transaction submitted ‚Äî waiting confirmation...', 'info', 6000);
          await tx.wait();
          showStatus(`"${skillName}" certificate minted ‚úî`, 'success', 4000);
          // refresh
          if (!document.getElementById('certificatesSection').classList.contains('hidden')) {
            loadUserCertificates();
          }
        } catch (err) {
          console.error('claimCertificate error', err);
          showStatus('Mint failed: ' + (err.reason || err.message || err), 'error', 8000);
        }
      }

      // ---------- Load user certificates ----------
      async function loadUserCertificates() {
        const grid = document.getElementById('certificatesGrid');
        const noEl = document.getElementById('noCertificates');
        grid.innerHTML = '';
        noEl.classList.add('hidden');

        if (!contract || !userAddress) {
          noEl.classList.remove('hidden');
          return;
        }

        try {
          showStatus('Fetching your certificates from chain...', 'info', 4000);
          const skills = await contract.getUserCertificates(userAddress);
          if (!skills || skills.length === 0) {
            noEl.classList.remove('hidden');
            showStatus('No certificates found.', 'info', 3000);
            return;
          }

          // newest first
          [...skills].reverse().forEach((skill, idx) => {
            const s = String(skill);
            let icon = 'üìú', color = 'blue';
            if (/coding/i.test(s)) { icon = 'üíª'; color = 'blue'; }
            else if (/design/i.test(s)) { icon = 'üé®'; color = 'purple'; }
            else if (/market/i.test(s)) { icon = 'üìà'; color = 'green'; }

            const card = document.createElement('div');
            card.className = `certificate-card bg-gradient-to-br from-${color}-50 to-${color}-100 p-6 rounded-lg border`;
            card.innerHTML = `
              <div class="text-4xl text-center mb-2">${icon}</div>
              <div class="text-lg font-semibold text-center mb-2">${s}</div>
              <div class="bg-white rounded p-3 text-xs text-slate-700">
                Owner: ${userAddress.slice(0,6)}...${userAddress.slice(-4)}<br/>
                Blockchain: Celo Mainnet
              </div>
            `;
            grid.appendChild(card);
          });

          showStatus('Certificates loaded', 'success', 3000);
        } catch (err) {
          console.error('loadUserCertificates error', err);
          showStatus('Failed to load certificates: ' + (err.reason || err.message || err), 'error', 7000);
          noEl.classList.remove('hidden');
        }
      }

      // ---------- Event bindings ----------
      document.getElementById('navHome').addEventListener('click', () => showSection('home'));
      document.getElementById('navSkills').addEventListener('click', () => showSection('skills'));
      document.getElementById('navCerts').addEventListener('click', () => showSection('certificates'));
      document.getElementById('ctaSkills').addEventListener('click', () => showSection('skills'));
      document.getElementById('connectBtn').addEventListener('click', connectWallet);

      // delegate claim buttons
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('.claim-btn');
        if (btn) {
          const skill = btn.getAttribute('data-skill');
          claimCertificate(skill);
        }
      });

      // reactive handlers
      if (window.ethereum) {
        window.ethereum.on('accountsChanged', (accounts) => {
          if (!accounts || accounts.length === 0) {
            // user disconnected
            userAddress = null;
            document.getElementById('connectBtn').textContent = 'Connect Wallet';
            showStatus('Wallet disconnected', 'info', 3000);
          } else {
            // reload to re-init
            location.reload();
          }
        });

        window.ethereum.on('chainChanged', () => {
          // simple reload on chain change to avoid stale provider
          location.reload();
        });
      }

      // initial view
      showSection('home');
    } // end initApp
  </script>
</body>
</html>
