<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SkillCert â€” Proof of Skill (Celo)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Use a stable ethers UMD -->
  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(135deg,#667eea,#764ba2); min-height:100vh;}
    .btn-primary{background:linear-gradient(90deg,#1e40af,#3b82f6)}
  </style>
</head>
<body class="min-h-screen text-slate-800">
  <!-- Navbar -->
  <nav class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="font-bold text-xl">ðŸŽ“ SkillCert</div>
      <button id="connectBtn" class="btn-primary text-white px-4 py-2 rounded">Connect Wallet</button>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto p-8">
    <header class="text-center text-white mb-8">
      <h1 class="text-4xl font-bold">Proof-of-Skill NFT Platform</h1>
      <p class="text-lg mt-2">Mint certificate NFTs on Celo Mainnet</p>
    </header>

    <section id="skills" class="grid md:grid-cols-3 gap-6">
      <div class="bg-white p-6 rounded-lg">
        <h3 class="font-bold text-lg">Coding</h3>
        <p class="text-sm text-slate-500">Algorithms, Data-Structures, Clean Code</p>
        <button class="mt-4 w-full py-2 rounded btn-primary text-white" onclick="claimCertificate('Coding')">Claim Certificate</button>
      </div>
      <div class="bg-white p-6 rounded-lg">
        <h3 class="font-bold text-lg">Design</h3>
        <p class="text-sm text-slate-500">UI/UX, Prototyping</p>
        <button class="mt-4 w-full py-2 rounded btn-primary text-white" onclick="claimCertificate('Design')">Claim Certificate</button>
      </div>
      <div class="bg-white p-6 rounded-lg">
        <h3 class="font-bold text-lg">Marketing</h3>
        <p class="text-sm text-slate-500">Growth, SEO, Analytics</p>
        <button class="mt-4 w-full py-2 rounded btn-primary text-white" onclick="claimCertificate('Marketing')">Claim Certificate</button>
      </div>
    </section>

    <section id="myCerts" class="mt-10 bg-white p-6 rounded-lg">
      <div class="flex justify-between items-center mb-4">
        <h2 class="font-bold">My Certificates</h2>
        <button class="text-sm text-blue-600" onclick="loadUserCertificates()">Refresh</button>
      </div>
      <div id="certGrid" class="grid md:grid-cols-3 gap-4"></div>
      <div id="noCert" class="text-slate-500 mt-4 hidden">No certificates yet.</div>
    </section>
  </main>

  <!-- status -->
  <div id="status" class="fixed bottom-6 right-6 hidden bg-white p-3 rounded shadow max-w-xs"></div>

  <script>
    // CONFIG
    const CONTRACT_ADDRESS = "0x1609a371790AaC42298Ded751E111f50057A71a4"; // deployed
    const ABI = [
      "function mintCertificate(string memory skillName) public returns (uint256)",
      "function getUserCertificates(address user) public view returns (string[] memory)"
    ];

    const CELO_MAINNET = {
      chainId: "0xa4ec",
      chainName: "Celo Mainnet",
      nativeCurrency: { name: "CELO", symbol: "CELO", decimals: 18 },
      rpcUrls: ["https://forno.celo.org"],
      blockExplorerUrls: ["https://explorer.celo.org"]
    };

    let provider, signer, contract, userAddress;

    function showStatus(msg, timeout = 4000) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.classList.remove('hidden');
      clearTimeout(window._statusTimer);
      window._statusTimer = setTimeout(() => el.classList.add('hidden'), timeout);
    }

    // Ensure ethers is available
    if (typeof ethers === 'undefined') {
      alert('Library error: ethers.js failed to load. Please check CDN. Contact dev.');
      throw new Error('ethers is not defined');
    }

    async function connectWallet() {
      if (!window.ethereum) { showStatus('Please install MetaMask', 5000); return; }
      try {
        showStatus('Connecting wallet...');
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userAddress = accounts[0];
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();

        const net = await provider.getNetwork();
        if (net.chainId !== 42220) {
          try {
            await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CELO_MAINNET.chainId }] });
            showStatus('Switched network to Celo. Reconnect...');
            return; // user should click connect again to re-init
          } catch (err) {
            if (err.code === 4902) {
              await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [CELO_MAINNET] });
              showStatus('Celo added. Please reconnect and switch to Celo Mainnet.');
              return;
            } else {
              throw err;
            }
          }
        }

        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        document.getElementById('connectBtn').textContent = `${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
        document.getElementById('connectBtn').classList.add('opacity-60');
        showStatus('Connected to Celo Mainnet', 3000);
        loadUserCertificates();
      } catch (err) {
        console.error(err);
        showStatus('Connection failed: ' + (err.reason || err.message || err), 6000);
      }
    }

    async function claimCertificate(skill) {
      if (!contract) { showStatus('Connect wallet first', 3000); return; }
      try {
        showStatus(`Minting ${skill}...`);
        const tx = await contract.mintCertificate(skill);
        showStatus('Transaction submitted. Waiting confirmation...');
        await tx.wait();
        showStatus('Certificate minted âœ”', 3000);
        loadUserCertificates();
      } catch (err) {
        console.error(err);
        showStatus('Mint failed: ' + (err.reason || err.message || err), 5000);
      }
    }

    async function loadUserCertificates() {
      const grid = document.getElementById('certGrid');
      const noCert = document.getElementById('noCert');
      grid.innerHTML = '';
      noCert.classList.add('hidden');

      if (!contract || !userAddress) { noCert.classList.remove('hidden'); return; }
      try {
        showStatus('Loading certificates...');
        const list = await contract.getUserCertificates(userAddress);
        if (!list || list.length === 0) { noCert.classList.remove('hidden'); showStatus('No certificates found',2000); return; }
        list.slice().reverse().forEach((skill, idx) => {
          const card = document.createElement('div');
          card.className = 'bg-white p-4 rounded shadow';
          card.innerHTML = `<div class="font-semibold">${skill}</div><div class="text-xs text-slate-500">#${idx+1}</div>`;
          grid.appendChild(card);
        });
        showStatus('Certificates loaded',2000);
      } catch (err) {
        console.error(err);
        showStatus('Failed to load: ' + (err.reason || err.message || err));
      }
    }

    // event binding
    document.getElementById('connectBtn').addEventListener('click', connectWallet);

    // reload on account/network change
    if (window.ethereum) {
      window.ethereum.on('accountsChanged', () => location.reload());
      window.ethereum.on('chainChanged', () => location.reload());
    }
  </script>
</body>
</html>
